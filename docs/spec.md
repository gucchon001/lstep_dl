# 機能仕様書

## 概要
本システムは、LINE公式アカウントの管理画面から会員データとアンケートデータを自動的にダウンロードし、指定されたGoogleスプレッドシートに転記するシステムです。PyInstaller対応により、exeファイルとして配布・実行が可能です。

## 主要機能

### 1. ログイン処理
- LINE公式アカウント管理画面への自動ログイン
- セッション管理とエラー処理
- 認証情報の安全な管理（secrets.env経由）
- reCAPTCHA認証の手動対応

### 2. データ取得
- 会員データのCSVダウンロード
  - チェックボックスによる項目選択（13項目）
  - 複数タグパターンによるフィルタリング
  - Shadow DOM要素の高度な操作
  - 流入経路の自動選択
- アンケートデータのCSVダウンロード
  - 最新データの自動検出
  - ダウンロード状態の監視

### 3. データ転記
- Googleスプレッドシートへの自動転記
- データ形式の変換と整形（cp932エンコーディング対応）
- シートの動的設定読み込み（settingsシート経由）

### 4. ログ管理
- 操作ログの記録（LogSpreadsheetクラス）
- エラー情報の詳細記録
- デバッグ情報の自動保存
- 日別ログファイルの自動生成

### 5. 通知機能
- Slack通知機能（エラー発生時）
- 詳細なエラー情報の通知

## 技術要件

### ブラウザ自動操作
- Selenium WebDriverを使用
- Chrome ブラウザを制御
- Shadow DOM要素の操作
  - 動的コンポーネントの待機
  - 要素の検索と操作
  - エラー時の代替手段
- 要素の待機処理
  - 明示的待機（WebDriverWait）
  - 動的要素の状態確認
  - タイムアウト制御
- エラーハンドリング
  - 要素取得失敗時の再試行
  - エラー状態からの復帰
  - デバッグ情報の自動保存

### データ処理
- CSVファイルの読み込みと解析
- データ形式の変換
- 文字コードの適切な処理
- 一時ファイルの管理

### API連携
- Google Sheets APIの利用
- OAuth2.0認証
- バッチ処理による効率化
- エラー時のリトライ処理

### セレクタ管理
- CSV形式でのセレクタ定義（config/selectors.csv）
- 複数の要素タイプに対応
  - CSS Selector
  - XPath
  - ID/Name
- Shadow DOM要素の特殊処理
- エラー時の代替セレクタ

### PyInstaller対応
- exe実行時のパス解決
- 一時展開ディレクトリの自動検出
- 開発環境・本番環境の自動切り替え

## 設定項目

### 環境設定（secrets.env）
- ADMIN_URL: ログインURL
- LOGIN_ID: ログインID
- LOGIN_PASSWORD: パスワード
- SERVICE_ACCOUNT_FILE: Googleサービスアカウントファイル
- SLACK_WEBHOOK: Slack通知用Webhook URL

### 実行設定（settings.ini）
- ブラウザのヘッドレスモード設定
- ログレベル設定（development/production）
- デバッグモード設定

### データ設定（settings.ini）
- スプレッドシートID
- シート名設定（友達リストDLデータ、アンケートDLデータ）
- タグパターン設定（複数パターン対応）

### タグ設定
- selected_tags: 第1タグパターン
- selected_tags2: 第2タグパターン
- inflow_label: 流入経路ラベル

## エラー処理

### 想定エラー
- ネットワークエラー
- 認証エラー
- 要素取得エラー
- ファイル操作エラー
- API通信エラー

### エラー対応
- エラーメッセージの詳細記録
- リトライ処理の実装
- エラー状態からの復帰
- Slack通知による運用者への通知
- スプレッドシートへのログ記録

## 運用要件

### 実行環境
- Windows 10以上
- Python 3.7以上
- Chrome ブラウザ最新版
- インターネット接続必須
- PyInstaller対応（exeファイル実行可能）

### メンテナンス
- ログファイルの自動日別管理
- 一時ファイルの自動削除
- セレクタの更新確認（selectors.csv）
- ブラウザの更新対応
- 設定ファイルの定期確認

### セキュリティ
- 認証情報の環境変数管理
- サービスアカウントファイルの安全な管理
- Slack通知のWebhook URL保護